# 02 – Configuring the Docker Lab Setup

This guide explains how to configure the Docker-based lab environment, access the containers from other PCs on the same network, and optionally SSH into the containers from the host machine.

---

## 1. Prepare the Environment

### a. Install Required Software
- Docker
- Docker Compose (v2 or later)
- Python 3 with `pyyaml` (`pip install pyyaml`)

### b. Clone or Copy the Project
- Place the project directory on your host machine.

---

## 2. Configure the Lab

### a. Set Up the .env File
- Copy `template.env` to `.env` inside the `docker/` directory:
  ```sh
  cd docker
  cp template.env .env
  ```
- Edit `.env` to define:
  - `NODE<n>`: Hostname and IP pairs in `name:ip` format (e.g., `NODE1=node1:192.168.0.101`)
  - `DOCKER_USER`: Username to create in each container (e.g., `admin`)
  - `DOCKER_PASS`: Password for the created user (e.g., `changeme`)
  - `MACVLAN_PARENT`: Host network interface to bridge for container LAN access (e.g., `eno1`)
  - `SUBNET`: Subnet for the macvlan network (e.g., `192.168.0.0/24`)
  - `GATEWAY`: Gateway for the macvlan network (e.g., `192.168.0.1`)

### b. Generate the Compose File
- Run the script from the `docker/` directory to generate `compose/docker-compose.yml`:
  ```sh
  python3 gen_compose.py
  ```

---

## 3. Launch the Lab

- Start the containers from the `compose/` directory:
  ```sh
  cd compose
  docker compose up -d --build
  ```
- Containers will be provisioned with static IPs and macvlan networking.
- User credentials are injected at container startup (never baked into the image).

---

## 4. Accessing Containers from Other PCs on the Same Network

### a. Ensure Host Network Configuration
- The host's LAN interface (e.g., `eno1`) must be connected to the same network as other PCs.
- Containers will have IPs in the LAN range (e.g., `192.168.0.101`).

### b. Verify Connectivity
- From another PC, ping a container's IP:
  ```sh
  ping 192.168.0.101
  ```
- SSH into the container:
  ```sh
  ssh admin@192.168.0.101
  # Password: as set in .env (DOCKER_PASS)
  ```

---

## 5. Optionally: SSH from the Host Machine


### Important: Macvlan Network & SSH Access from Host

By default, containers attached to a Docker `macvlan` network are **not accessible from the host** (the host cannot reach the macvlan subnet). This means SSH from the host to a container will **fail** unless you add a network route.

#### 1. Add a Temporary Route (for current session)

Replace `192.168.0.0/24` with your macvlan subnet and `eno1` with your parent interface:
```sh
sudo ip route add 192.168.0.0/24 dev eno1
```
After this, you can SSH from the host:
```sh
ssh admin@192.168.0.101
```

#### 2. Make the Route Persistent (Survives Reboot)

**On Ubuntu with Netplan:**
1. Edit the appropriate `/etc/netplan/*.yaml` file and add under your interface:
   ```yaml
   network:
    ethernets:
      eno1:
       routes:
        - to: 192.168.0.0/24
          via: 0.0.0.0
   ```
2. Apply changes:
   ```sh
   sudo netplan apply
   ```

**On Debian/Ubuntu with `/etc/network/interfaces`:**
1. Add this under the `iface` section for `eno1`:
   ```
   up ip route add 192.168.0.0/24 dev eno1
   ```

**On systems using `/etc/rc.local`:**
1. Add before `exit 0`:
   ```sh
   ip route add 192.168.0.0/24 dev eno1
   ```

#### 3. Limitations & Alternatives

- This is a Docker/macvlan limitation: the host is isolated from the macvlan network by default.
- You can use a bridge network (less isolation, but host access works out of the box), or set up a dedicated "gateway" container to proxy traffic.

---

### Configure SSH Access Without Password

If you want passwordless SSH access from the host:

1. Generate an SSH key on the host (if you don't have one):
  ```sh
  ssh-keygen -t ed25519 -C "user@example.com"
  # Press Enter to accept defaults
  ```

2. Copy your public key to each container:
  ```sh
  ssh-copy-id admin@192.168.0.101
  ssh-copy-id admin@192.168.0.102
  # Enter the password as set in .env
  ```

3. Now you can SSH without a password:
  ```sh
  ssh admin@192.168.0.101
  ```

Or use Docker's exec:
  ```sh
  docker exec -it <container> bash
  ```

---

## 6. Directory Structure

```
docker/
├── compose/
│   └── docker-compose.yml       # Generated by gen_compose.py
├── images/
│   └── base/
│       └── Dockerfile           # Base image for all lab containers
├── scripts/
│   └── entrypoint.sh            # Creates the lab user at startup
├── gen_compose.py               # Reads .env, generates compose file
├── docker-compose.yml.template  # Reference example
├── template.env                 # Example .env — copy and customise
└── README.md
```

---

## 7. Troubleshooting

- If you cannot access containers from other PCs:
  - Check that the host firewall allows traffic to/from the container IPs.
  - Ensure the macvlan parent interface is correctly configured.
  - Verify containers are running and have the expected IPs.
  - Remember that systemd is not fully supported in containers by default; some services may not work as expected.
- If you see `no configured subnet contains IP address` errors:
  - Ensure the node IPs in `.env` are within the configured `SUBNET`.
  - Regenerate the compose file with `python3 gen_compose.py`.

---

## Summary

1. Install dependencies and clone the project.
2. Configure `docker/.env` for your network and container needs.
3. Generate the compose file: `python3 gen_compose.py`
4. Launch the lab: `cd compose && docker compose up -d --build`
5. Access containers from other PCs or the host using SSH.

For advanced networking or persistent routes, see the main documentation.
